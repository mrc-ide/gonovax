---
title: "Getting started"
author: "Lilith Whittles"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Getting started}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
par(mar = c(3, 3, 1, 1), mgp = c(1.7, 0.7, 0), bty = "n")
```


## Running the model without vaccination

First we will run the model without vaccination.

Start by reading in your table of parameters:
```{r}
 library("gonovax")
 parameter_table <- read.csv(system.file("extdata/gono_params_t.csv",package='gonovax'))
 head(parameter_table)
```

We need to transform the table of parameters to the format the model requires
using the `transform_fixed` function. First we only use 100 parameter sets:
```{r}
n_par <- 100

# transform the parameter table
gono_params <- lapply(seq_len(n_par),
                      function(i) transform_fixed(parameter_table[i, ]))

```

We then run the model to equilibrium without vaccination, and save the final states for each parameter set so we can restart with vaccination:
```{r}
tt <- c(0, 50)

# run the model
#y0 <- run_onevax_xvwv(tt, gono_params)

#


n_diag_rec = 2

y0 <- run_onevax_xpvwrh(tt, gono_params, n_diag_rec = n_diag_rec, PN = "yes")


# get final (equilibrium) model state to use as starting point of run with vaccination
init_params <- lapply(y0, restart_params)
```

## Running the model with vaccination

We now run the model with vaccination.

The efficacy inputs (`vea`, `vei`, `ved`, `ves`) can be of length 1 or `n_par`

The strategy can be one of:

* `VoD`: vaccination on diagnosis
* `VoA`: vaccination on attendance
* `VoD(L)+VoA(H)`: targeted vaccination (i.e. all diagnosed plus group H on screening)

The proportion of those eligible that choose to be vaccinated, `uptake` is a
scalar from 0 to 1:

```{r}


n_dia
g_rec = 2
 
# generate vaccine effects parameters
ve <- data.frame(vea = 0.4, # efficacy against acquisition
                 vei = 0.0, # efficacy against infectiousness
                 ved = 0.0, # efficacy against duration of infection
                 ves = 0.0) # efficacy against symptoms

tt <- seq(0, 10)
# y <- run_onevax_xvwv(tt,
#                      gono_params = gono_params,
#                      init_params = init_params, 
#                      vea = ve$vea, ved = ve$ved, ves = ve$ves,
#                      uptake = 1, strategy = "VoA")


#gono_params[[1]]$beta_t = c(0,0)



## DIAGNOSIS WITH VACCINATION NOW LOOKS GOOD - BUT STILL NEED TO DO PROPER SANITY CHECKS (14 JULY)





y <- run_onevax_xpvwrh(tt,
                     gono_params = gono_params,
                     init_params = init_params,
                     vea = ve$vea, ved = ve$ved, ves = ve$ves, strategy = NULL, n_erlang = 1, n_diag_rec = n_diag_rec, r1 = 0.41, r2 = 0.6, PN = "yes")


yRD <- run_onevax_xpvwrh(tt,
                     gono_params = gono_params,
                     init_params = init_params,
                     vea = ve$vea, ved = ve$ved, ves = ve$ves, strategy = "VaH", n_erlang = 1, n_diag_rec = n_diag_rec, r1 = 0.41, r2 = 0.6, PN = "yes")


yD <- run_onevax_xpvwrh(tt,
                     gono_params = gono_params,
                     init_params = init_params, 
                     vea = ve$vea, ved = ve$ved, ves = ve$ves, strategy = "VoD", n_erlang = 1, n_diag_rec = n_diag_rec, r1 = 0.41, r2 = 0.6, PN = "yes")


yR <- run_onevax_xpvwrh(tt,
                     gono_params = gono_params,
                     init_params = init_params,
                     vea = ve$vea, ved = ve$ved, ves = ve$ves, strategy = "VoD(L)+VoA(H)", n_erlang = 1, n_diag_rec = n_diag_rec, r1 = 0.41, r2 = 0.6, PN = "yes")


#gono_params[[1]]$notification_param = (0.17*temp4[2])/temp3[2]

tempC = numeric(length = 1)
tempD = numeric(length = 1)


tempZZ = numeric(length = 1)

yPN <- run_onevax_xpvwrh(tt,
                     gono_params = gono_params,
                     init_params = init_params, 
                     vea = ve$vea, ved = ve$ved, ves = ve$ves, strategy = "VoN", n_erlang = 1, n_diag_rec = n_diag_rec, r1 = 0, r2 = 0, PN = "yes")

for (i in 1:100){
tempA = yPN[[i]]$cum_diag_a[,1,] + yPN[[i]]$cum_diag_a[,2,] + yPN[[i]]$cum_diag_s[,1,] + yPN[[i]]$cum_diag_s[,2,]
#tempB = yPN[[i]]$cum_offered_pn[,1,] + yPN[[i]]$cum_offered_pn[,2,]

tempB = sum(yPN[[i]]$phi[1,1,] + yPN[[i]]$phi[1,2,])

tempC[i] = sum(tempA[2,1:3])
tempD[i] = tempB #sum(tempB[2, 1:3])

#print(tempC[i])
#print(tempD[i])
  
  
tempX = yPN[[i]]$phi[1,1,1] + yPN[[1]]$phi[1,2,1]
tempY = yPN[[i]]$notifiedandattended[1,1,1] + yPN[[1]]$notifiedandattended[1,2,1]

#print(tempX)
#print(tempY)
print(1 - tempX/tempY)

tempZZ[i] = 1 - tempX/tempY

gono_params[[i]]$kappa = 0.17*tempC[i]/tempD[i]
}


yPN2 <- run_onevax_xpvwrh(tt,
                     gono_params = gono_params,
                     init_params = init_params, 
                     vea = ve$vea, ved = ve$ved, ves = ve$ves, strategy = "VoN", n_erlang = 1, n_diag_rec = n_diag_rec, r1 = 0.41, r2 = 0.6, PN = "yes")

tempC2 = numeric(length = 1)
tempD2 = numeric(length = 1)

for (i in 1:100){
tempA = yPN2[[i]]$cum_diag_a[,1,] + yPN2[[i]]$cum_diag_a[,2,] + yPN2[[i]]$cum_diag_s[,1,] + yPN2[[i]]$cum_diag_s[,2,]
tempB = yPN2[[i]]$cum_offered_pn[,1,] + yPN2[[i]]$cum_offered_pn[,2,]
tempC2[i] = sum(tempA[2,1:3])
tempD2[i] = sum(tempB[2, 1:3])

print(tempC2[i])
  print(tempD2[i])

#gono_params[[i]]$kappa = 0.17*tempD[i]/tempC[i]
}




# yD <- run_onevax_xvwv_Diagnosis(tt,
#                      gono_params = gono_params,
#                      init_params = init_params, 
#                      vea = ve$vea, ved = ve$ved, ves = ve$ves, strategy = "VoD", uptake = 1, n_diag_rec = 3)
# 
# 
# yRD <- run_onevax_xvwv_Diagnosis(tt,
#                      gono_params = gono_params,
#                      init_params = init_params, 
#                      vea = ve$vea, ved = ve$ved, ves = ve$ves, strategy = "VoRD", uptake = 1, n_diag_rec = 3)
# 
# yR <- run_onevax_xvwv_Diagnosis(tt,
#                      gono_params = gono_params,
#                      init_params = init_params, 
#                      vea = ve$vea, ved = ve$ved, ves = ve$ves, strategy = "VoD(L)+VoA(H)", uptake = 1, n_diag_rec = 3)


tempX = yPN[[1]]$phi[1,1,1] + yPN[[1]]$phi[1,2,1]
tempY = yPN[[1]]$notifiedandattended[1,1,1] + yPN[[1]]$notifiedandattended[1,2,1]

#print(tempX)
#print(tempY)
#print(1 - tempX/tempY)



tempX2 = yPN2[[1]]$phi[1,1,1] + yPN2[[1]]$phi[1,2,1]
tempY2 = yPN2[[1]]$notifiedandattended[1,1,1] + yPN2[[1]]$notifiedandattended[1,2,1]

#print(tempX2)
#print(tempY2)
#print(1 - tempX2/tempY2)


#print(yPN[[1]]$phi[1,1,1] + yPN[[1]]$phi[1,2,1])
#print(yPN[[1]]$notifiedandattended[1,1,1] + yPN[[1]]$notified[1,2,1])



```

`y` is now a list of model runs of length `n_par`, each entry contains a list of
model outputs. Each of these list entries `y[[i]]` is a list of model output
arrays with dimensions: time, group (L, H), and vaccine status (X, V, W)
where applicable

```{r}
names(y[[1]])
dim(y[[1]]$cum_incid)
dimnames(y[[1]]$cum_incid)

# cumulative incidence in unvaccinated group L over time
y[[1]]$cum_incid[, "L", "X.I"]
```

## Graphical representations of results

This can be aggregated over group (L, H) and strata (X, V, W) to give the total
cumulative infections for each parameter set (rows) over time (columns).

```{r}
total_vaccinated <- aggregate(y, what = "cum_vaccinated")
col <- rgb(0.5, 0.5, 0.5, 0.3)
matplot(tt, t(total_vaccinated), lty = 1, type = "l", col = col,
        xlab = "Time", ylab = "Cumulative vaccinations")
```

This can be aggregated over group (L, H) and strata (X, V, W) to give the yearly
infections for each parameter set (rows) over time (columns).

```{r}
annual_infected <- aggregate(y, what = "cum_incid", as_incid = TRUE)
matplot(tt[-1], t(annual_infected), lty = 1, type = "l", col = col,
        xlab = "Time", ylab = "Annual infections")
```

You can look at individual vaccine strata:

```{r}
annual_infected_X <- aggregate(y, what = "cum_incid", as_incid = TRUE,
                             stratum = "X.I")
annual_infected_V <- aggregate(y, what = "cum_incid", as_incid = TRUE,
                             stratum = "V1.I")
col1 <- rgb(0.5, 0, 0, 0.3)
col2 <- rgb(0, 0, 0.5, 0.3)
matplot(tt[-1], t(annual_infected_X), lty = 1, type = "l", col = col1,
        xlab = "Time", ylab = "Annual infections")
matlines(tt[-1], t(annual_infected_V), lty = 1, col = col2)
legend("top", fill = c(col1, col2), legend = c("Unvaccinated", "Vaccinated"),
       ncol = 2)
```

You can apply functions over the parameter sets to get summary statistics:

```{r}
mean_ci <- function(x) c(mean = mean(x), quantile(x, c(0.025, 0.975)))
summary_annual_infected_X <- aggregate(y, what = "cum_incid", as_incid = TRUE,
                             stratum = "X.I", f = mean_ci)
summary_annual_infected_V <- aggregate(y, what = "cum_incid", as_incid = TRUE,
                             stratum = "V1.I", f = mean_ci)
col1 <- "red"
col2 <- "blue"
col3 <- "green"
matplot(tt[-1], t(summary_annual_infected_X), lty = c(1, 2, 2), type = "l", col = col1,
        xlab = "Time", ylab = "Annual infections")
matlines(tt[-1], t(summary_annual_infected_V), lty = c(1, 2, 2), col = col2)
legend("top", fill = c(col1, col2, col3), legend = c("VaR", "VaH", "VoD"),
       ncol = 3)
```



```{r}
mean_ci <- function(x) c(mean = mean(x), quantile(x, c(0.025, 0.975)))

summary_vaccinated <- aggregate(yR, what = "cum_vaccinated",  f = mean_ci)
col1 <- "green"
matplot(tt, t(summary_vaccinated), lty = c(1, 2, 2), type = "l", col = col1,
        xlab = "Time", ylab = "Cumulative vaccinations")

summary_vaccinated2 <- aggregate(yRD, what = "cum_vaccinated", f = mean_ci)
col2 <- "blue"
matlines(tt, t(summary_vaccinated2), lty = c(1, 2, 2), col = col2)

summary_vaccinated3 <- aggregate(yD, what = "cum_vaccinated", f = mean_ci)
col3 <- "red"
matlines(tt, t(summary_vaccinated3), lty = c(1, 2, 2), col = col3)


summary_vaccinated3 <- aggregate(yPN2, what = "cum_vaccinated", f = mean_ci)
col4 <- "grey"
matlines(tt, t(summary_vaccinated3), lty = c(1, 2, 2), col = col4)



legend("bottom", fill = c(col1, col2, col3, col4), legend = c("VaR", "VaH", "VoD", "VoPN"),
       ncol = 4)

```


```{r}
mean_ci <- function(x) c(mean = mean(x), quantile(x, c(0.025, 0.975)))

summary_vaccinated <- aggregate(yPN, what = "cum_diag_s",  f = mean_ci) + aggregate(yPN, what = "cum_diag_a",  f = mean_ci)
col1 <- "blue"
matplot(tt, t(summary_vaccinated), lty = c(1, 2, 2), type = "l", col = col1,
        xlab = "Time", ylab = "Cumulative diagnosed")
title(main = "1-year recent diagnoses")


legend("bottom", fill = c(col1), legend = c("VaH"),
       ncol = 4)

```


```{r}
summary_vaccinated <- aggregate_group(yR, what = "cum_vaccinated", group = 1,  f = mean_ci)
col1 <- "green"
matplot(tt, t(summary_vaccinated), lty = c(1, 2, 2), type = "l", col = col1, ylim = c(0, 120000),
        xlab = "Time", ylab = "Cumulative vaccinations (low-risk)")

#summary_vaccinated2 <- aggregate_group(yRD, what = "cum_vaccinated", group = 1, f = mean_ci)
#col2 <- "blue"
#matlines(tt, t(summary_vaccinated2), lty = c(1, 2, 2), col = col2)

summary_vaccinated3 <- aggregate_group(yD, what = "cum_vaccinated", group = 1, f = mean_ci)
col3 <- "red"
matlines(tt, t(summary_vaccinated3), lty = c(1, 2, 2), col = col3)


#summary_vaccinated3 <- aggregate_group(yPN, what = "cum_vaccinated", group = 1, f = mean_ci)
#col4 <- "grey"
#matlines(tt, t(summary_vaccinated3), lty = c(1, 2, 2), col = col4)


legend("top", fill = c(col1, col2, col3, col4), legend = c("VaR", "VaH", "VoD", "VoPN"),
       ncol = 4)




```
